# Grace Compiler

The compiler uses the LLVM compiler infrastructure to generate intermediate representation (IR) of the source code, which can then be compiled and linked into machine code.

## Files Description

### `irgen.c`

This file handles the generation of LLVM IR from the Abstract Syntax Tree (AST) that is generated by the parser.

The primary function of `irgen.c` is `generate_ir(ast node)`, which walks the AST and generates corresponding LLVM IR code for each AST node. Depending on the type of AST node (`node->k`), different IR instructions are generated.

Here is an overview of how IR generation is handled for different types of AST nodes:

- `FUNCTION_DEF`: Defines a new function by creating a new LLVM function with the return type and parameters specified in the AST node. It also sets up an entry basic block for the function's body.

- `VAR`: Allocates memory for a new variable by creating an `alloca` instruction in LLVM, which allocates memory on the stack.

- `ASSIGN`: Generates IR code for assignment statements. This involves generating the IR code for the expression on the right-hand side of the assignment and then storing the result into the variable on the left-hand side using a `store` instruction.

- `FUNC_CALL`: Handles function calls by generating the LLVM `call` instruction. It special cases the built-in function "puts" to print strings to the console.

- `BLOCK`: Generates a sequence of IR instructions for each statement in the block by calling `generate_ir` on each statement in turn.

- `RETURN`: Generates a `ret` instruction in LLVM. This involves generating the IR code for the expression being returned and then creating a `ret` instruction that returns that value.

- `NUM`: Returns a constant integer by creating an LLVM constant integer object.

- `STR`: Handles string literals by creating a `global string pointer` in LLVM for each string.

After generating the IR, it uses LLVM functions to print and clean up the IR code.

### `parser.y`

This file contains the grammar for the MiniBasic language written using Yacc syntax. The yacc program processes this file and produces a syntax analyzer (`parser.c`).

The grammar rules define how to construct an AST from the input source code. The yacc program will call `yyerror()` when it encounters a syntax error.

### `print.c`
This code prints out the AST.

### `makefile`

This file defines rules to build the compiler by linking together the object files (`*.o`) produced by the C compiler from the source files (`lexer.c`, `parser.c`, `ast.c`, `irgen.c`, `print.c`). It also includes rules to clean up the intermediate files produced during the build.

### `mbc.sh`

This script is a wrapper for the whole process of compiling a source code file. It first runs the `minibasic` compiler on the input source code (`$1`), and the output is LLVM IR code. Then it uses LLVM's `llc` to compile the LLVM IR code to an object file. Finally, it uses `clang` to link the object file with a provided library (`libio/lib/x86/libio.a`) to produce the final executable.

## How to Use the Compiler

1. First, ensure that you have `llvm`, `clang`, and `bison` installed on your system.

2. Run `make` to build the compiler. This will generate the `minibasic` executable.

3. Run `./mbc.sh <source_file>` to compile a source code file. Replace `<source_file>` with the path to the source code file you want to compile. This will generate an executable named `output`. 

## Sample Run
To run a MiniBasic program, you would execute the following commands:

```bash
$ make
$ ./mbc.sh examples/helloworld.mba
$ ./output
```
These commands build the compiler, compile the `helloworld.mba` example program, and run the resulting executable.

In case of any errors or issues, please revisit your code to ensure it aligns with the grammar specified in the `parser.y` file.